<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartCargo-ADVISORY — Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{--brand:#0b4a6f;--accent:#ffb703;}
  body{font-family:Inter,system-ui,Arial,sans-serif;background:#f3f7fb;color:#0b2135;}
  header{background:var(--brand);color:white;padding:18px 12px;}
  .nav-btn{background:transparent;border:0;color:white;margin-right:8px}
  .panel{display:none;background:white;border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(10,20,30,0.06);margin:18px 0}
  .panel.active{display:block}
  #assistantBox{position:fixed;right:18px;bottom:18px;width:340px;z-index:1200}
  #chat{height:240px;overflow:auto;background:white;padding:12px;border-radius:8px;border:1px solid #e6eef6}
  .msg-user{color:#023047;font-weight:600}
  .msg-aipa{color:#0b4a6f}
  .lang-btn{margin-right:6px}
  .alert-dot{display:inline-block;width:10px;height:10px;background:#ff4d4f;border-radius:50%;margin-left:6px}
  footer{font-size:13px;color:#50657a;padding:10px 0;text-align:center}
  .small-muted{font-size:13px;color:#6b7b8c}
</style>
</head>
<body>

<header class="d-flex align-items-center justify-content-between flex-wrap">
  <div class="d-flex align-items-center">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect width='36' height='36' rx='6' fill='%230b4a6f'/><text x='6' y='24' font-size='18' fill='white'>A</text></svg>" alt="logo" style="margin-right:10px">
    <div>
      <h4 style="margin:0">SmartCargo-ADVISORY</h4>
      <div class="small-muted">Asesoría preventiva para proteger la mercancía del cliente</div>
    </div>
  </div>

  <div class="d-flex align-items-center">
    <nav>
      <button class="nav-btn" onclick="showPanel('panelCargas')">Cargas</button>
      <button class="nav-btn" onclick="showPanel('panelDocs')">Documentos</button>
      <button class="nav-btn" onclick="showPanel('panelAlerts')">Alertas</button>
      <button class="nav-btn" onclick="showPanel('panelPayments')">Pagos</button>
      <button class="nav-btn" onclick="showPanel('panelConfig')">Config</button>
    </nav>
  </div>
</header>

<main class="container my-3">

  <!-- PANEL: CARGAS -->
  <section id="panelCargas" class="panel active">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0" id="titleCargas">Active Shipments</h5>
      <div>
        <button class="btn btn-sm btn-outline-primary" onclick="refreshCargas()">Refresh</button>
        <button class="btn btn-sm btn-outline-success" onclick="openNewCargaModal()">+ New</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover" id="tableCargas">
        <thead class="table-light">
          <tr><th>ID</th><th>Client</th><th>Type</th><th>Status</th><th>Alerts</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- PANEL: DOCUMENTOS -->
  <section id="panelDocs" class="panel">
    <div class="d-flex justify-content-between">
      <h5>Documents / Upload</h5>
      <div class="small-muted">Supported: AWB, Invoice, Packing List, SLI</div>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-6">
        <input id="docFile" class="form-control" type="file" />
      </div>
      <div class="col-md-6">
        <button class="btn btn-primary" onclick="uploadDoc()">Upload & Analyze</button>
      </div>
    </div>

    <div id="docResult" class="mt-3 small-muted"></div>
  </section>

  <!-- PANEL: ALERTAS & SIMULATIONS -->
  <section id="panelAlerts" class="panel">
    <h5>Alerts & Simulations</h5>

    <div class="row g-3 mt-2">
      <div class="col-md-4">
        <label class="form-label">Cargo type</label>
        <select id="simTipo" class="form-select">
          <option value="Perishables">Perishables</option>
          <option value="DG">Dangerous Goods</option>
          <option value="Animals">Live Animals</option>
          <option value="Fragile">Fragile</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Detected Issues (count)</label>
        <input id="simCount" class="form-control" type="number" min="0" value="0" />
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-warning w-100" onclick="runSimulation()">Run Simulation</button>
      </div>
    </div>

    <div id="simResult" class="mt-3"></div>
  </section>

  <!-- PANEL: PAGOS -->
  <section id="panelPayments" class="panel">
    <h5>Subscriptions & Services</h5>
    <p class="small-muted">Choose one plan or pay per service. Payments processed securely by Stripe.</p>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-primary" onclick="startPayment(29,'Basic Monthly')">Basic Monthly — $29</button>
      <button class="btn btn-primary" onclick="startPayment(59,'Premium Monthly')">Premium Monthly — $59</button>
      <button class="btn btn-outline-primary" onclick="startPayment(295,'Basic Annual')">Basic Annual — $295</button>
      <button class="btn btn-primary" onclick="startPayment(595,'Premium Annual')">Premium Annual — $595</button>
    </div>

    <hr />
    <h6>Pay per service</h6>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-sm btn-outline-secondary" onclick="startPayment(10,'Upload & Verify Cargo')">$10 Upload & Verify</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="startPayment(15,'Advanced Simulation')">$15 Simulation</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="startPayment(12,'Report PDF/Excel')">$12 Report</button>
    </div>
  </section>

  <!-- PANEL: CONFIG -->
  <section id="panelConfig" class="panel">
    <h5>Configuration & Language</h5>
    <div class="d-flex gap-2 mt-2">
      <button class="btn btn-outline-dark lang-btn" onclick="setLang('en')">English</button>
      <button class="btn btn-outline-dark lang-btn" onclick="setLang('es')">Español</button>
      <button class="btn btn-outline-dark lang-btn" onclick="setLang('fr')">Français</button>
      <button class="btn btn-outline-dark lang-btn" onclick="setLang('de')">Deutsch</button>
      <button class="btn btn-outline-dark lang-btn" onclick="setLang('pt')">Português</button>
      <button class="btn btn-outline-dark lang-btn" onclick="setLang('zh')">中文</button>
    </div>

    <div class="mt-3 small-muted">
      <p><b>Backend URL:</b> <span id="backendUrlDisplay"></span></p>
      <p>Tip: configure CORS in backend to allow this frontend origin for production.</p>
    </div>
  </section>

</main>

<!-- ASSISTANT -->
<div id="assistantBox">
  <div class="card" style="border-radius:12px;overflow:hidden">
    <div class="card-body p-2">
      <h6 class="mb-2" style="color:white;background:var(--brand);padding:8px;border-radius:6px">AIPA Assistant</h6>
      <div id="chat"></div>
      <div class="mt-2">
        <input id="qInput" class="form-control mb-2" placeholder="Ask the assistant (e.g. 'Prepare pallet for perishables')">
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-warning w-100" onclick="askAssistant()">Ask</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="my-3">
  <div class="container small-muted">SmartCargo-ADVISORY • Advising only — not a certifier • © SmartCargo</div>
</footer>

<script>
/* ========== CONFIG — CHANGE BACKEND_URL to your deployed backend ========== */
const BACKEND_URL = "<REPLACE_WITH_YOUR_SMARTCARGO-AIPA_URL>"; // e.g. https://smartcargo-aipa.onrender.com
document.getElementById('backendUrlDisplay').innerText = BACKEND_URL;

/* ========== TRANSLATIONS (minimal core strings) ========== */
const LANGS = {
  en: {cargas:"Active Shipments", docs:"Documents / Upload", alerts:"Alerts & Simulations"},
  es: {cargas:"Cargas activas", docs:"Documentos / Subir", alerts:"Alertas & Simulaciones"},
  fr: {cargas:"Envois actifs", docs:"Documents / Téléverser", alerts:"Alertes & Simulations"},
  de: {cargas:"Aktive Sendungen", docs:"Dokumente / Hochladen", alerts:"Warnungen & Simulationen"},
  pt: {cargas:"Remessas ativas", docs:"Documentos / Enviar", alerts:"Alertas & Simulações"},
  zh: {cargas:"活动货件", docs:"文件 / 上传", alerts:"警报与模拟"}
};
let LANG = 'en';
function setLang(l){ LANG = l; // update minimal UI labels
  document.getElementById('titleCargas').innerText = LANGS[l]?.cargas || LANGS['en'].cargas;
}

/* ========== Utility & UI helpers ========== */
function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
async function feedback(message, type='info'){
  // simple alert
  alert(message);
}

/* ========== CARGAS: fetch and render ========== */
async function refreshCargas(){
  try {
    const res = await fetch(`${BACKEND_URL}/cargas`);
    if(!res.ok) throw new Error('Failed to fetch loads');
    const cargas = await res.json();
    const tbody = document.querySelector('#tableCargas tbody');
    tbody.innerHTML = '';
    // Expecting array of objects or rows
    (Array.isArray(cargas) ? cargas : (cargas.cargas || [])).forEach(c=>{
      // c may be dict or array
      const id = c.id ?? c[0];
      const client = c.cliente ?? c.client_name ?? (c[1] ?? '');
      const tipo = c.tipo_carga ?? c.tipo ?? c[2] ?? '';
      const estado = c.estado ?? c[3] ?? 'En revisión';
      const alertas = c.alertas ?? c[4] ?? 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${id}</td><td>${client}</td><td>${tipo}</td><td>${estado}</td>
        <td>${alertas>0?`<span style="color:#d9534f;font-weight:700">${alertas}</span>`:alertas}</td>
        <td><button class="btn btn-sm btn-outline-secondary" onclick="viewCarga(${id})">View</button></td>`;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error(e);
    feedback("Unable to load cargas. Check backend URL and CORS.");
  }
}
async function viewCarga(id){
  feedback("Open carga details: " + id);
}

/* ========== NEW CARGA modal (simple prompt) ========== */
function openNewCargaModal(){
  const client = prompt("Client name (required):");
  if(!client) return;
  const tipo = prompt("Cargo type (e.g. Perishables, DG, Fragile):","Perishables");
  createCarga({cliente: client, tipo_carga: tipo});
}
async function createCarga(payload){
  try{
    const res = await fetch(`${BACKEND_URL}/cargas`,{
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('create failed');
    const data = await res.json();
    feedback("Carga created id: " + (data.id || 'OK'));
    refreshCargas();
  } catch(e){
    console.error(e); feedback("Error creating carga.");
  }
}

/* ========== DOCUMENTS upload ========== */
async function uploadDoc(){
  const input = document.getElementById('docFile');
  if(!input.files || input.files.length===0){ feedback("Choose a file first"); return; }
  const file = input.files[0];
  const fd = new FormData();
  fd.append('file', file);

  try{
    const res = await fetch(`${BACKEND_URL}/upload`, { method: 'POST', body: fd });
    if(!res.ok) throw new Error('upload failed');
    const j = await res.json();
    document.getElementById('docResult').innerText = j.message + " — " + (j.data?.filename || '');
    feedback("File uploaded and analyzed.");
  } catch (e){
    console.error(e); feedback("Error uploading document.");
  }
}

/* ========== SIMULATION ========== */
async function runSimulation(){
  const tipo = document.getElementById('simTipo').value;
  const count = parseInt(document.getElementById('simCount').value || '0',10);
  try{
    const res = await fetch(`${BACKEND_URL}/simulacion/${encodeURIComponent(tipo)}/${count}`);
    if(!res.ok) throw new Error('sim error');
    const j = await res.json();
    const html = `<div class="p-3" style="background:#fffbe6;border-radius:8px">
      <b>Risk:</b> ${j.riesgo_rechazo || j.risk || 'N/A'}<br>
      <i>${j.mensaje || j.message || ''}</i></div>`;
    document.getElementById('simResult').innerHTML = html;
  } catch(err){
    console.error(err);
    feedback('Simulation failed. Backend endpoint /simulacion must exist.');
  }
}

/* ========== ASSISTANT ========== */
async function askAssistant(){
  const q = document.getElementById('qInput').value.trim();
  if(!q) return;
  const chat = document.getElementById('chat');
  chat.innerHTML += `<div class="msg-user">You: <span class="small-muted">${escapeHtml(q)}</span></div>`;
  document.getElementById('qInput').value = '';

  try{
    const res = await fetch(`${BACKEND_URL}/advisory`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({question: q})
    });
    const j = await res.json();
    const answer = (j.data?.analisis || j.data?.advisory || j.advisory || j.data || j) ;
    chat.innerHTML += `<div class="msg-aipa">AIPA: <span class="small-muted">${escapeHtml(JSON.stringify(answer)).slice(0,800)}</span></div>`;
    chat.scrollTop = chat.scrollHeight;
  } catch(e){
    console.error(e);
    chat.innerHTML += `<div class="msg-aipa">AIPA: <i>Assistant unavailable — check backend.</i></div>`;
  }
}

/* ========== SAVE ANALYSIS (example) ========== */
async function saveAnalysis(){
  const client = prompt("Client name for report:");
  if(!client) return;
  const cargo_json = JSON.stringify({sample:'cargo'});
  const advisory_json = JSON.stringify({sample:'advice'});
  const fd = new FormData();
  fd.append('client_name', client);
  fd.append('cargo_json', cargo_json);
  fd.append('advisory_json', advisory_json);
  try{
    const res = await fetch(`${BACKEND_URL}/save-analysis`, {method:'POST', body: fd});
    const j = await res.json();
    feedback(j.message || 'Saved');
  } catch(e){
    console.error(e); feedback('Save failed');
  }
}

/* ========== PAYMENTS: call backend to create checkout session ========= */
async function startPayment(amount, desc){
  try{
    const fd = new FormData();
    fd.append('amount', parseInt(amount*100)); // if backend expects cents or unit amount adjust
    fd.append('description', desc);
    // try /create-payment or /create-checkout-session fallback
    let res = await fetch(`${BACKEND_URL}/create-payment`, {method:'POST', body: fd});
    if(!res.ok){
      res = await fetch(`${BACKEND_URL}/checkout`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({precio: amount, success: window.location.href, cancel: window.location.href})});
    }
    const j = await res.json();
    // support either {url:...} or {data: {url:...}}
    const url = j.url || j.data?.url || j.data?.sessionUrl || j.session?.url;
    if(!url){ feedback('Payment creation failed. See console.'); console.log(j); return; }
    window.location.href = url;
  } catch(e){
    console.error(e); feedback('Payment error');
  }
}

/* ========== small helpers ========= */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

/* ========== Init ========= */
(function init(){
  setLang('en');
  refreshCargas();
})();
</script>
</body>
</html>
